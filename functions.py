import re
import sqlite3
import pandas as pd
from datetime import datetime
from config import DATABASE_PATH


def transliterate(string):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ —Å –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü—É.
    """
    capital_letters = {
        u'–ê': u'A', u'–ë': u'B', u'–í': u'V', u'–ì': u'G', u'–î': u'D', u'–ï': u'E', u'–Å': u'E', u'–ó': u'Z',
        u'–ò': u'I', u'–ô': u'Y', u'–ö': u'K', u'–õ': u'L', u'–ú': u'M', u'–ù': u'N', u'–û': u'O', u'–ü': u'P',
        u'–†': u'R', u'–°': u'S', u'–¢': u'T', u'–£': u'U', u'–§': u'F', u'–•': u'H', u'–™': u'', u'–´': u'Y',
        u'–¨': u'', u'–≠': u'E',
    }

    capital_letters_transliterated_to_multiple_letters = {
        u'–ñ': u'Zh', u'–¶': u'Ts', u'–ß': u'Ch', u'–®': u'Sh', u'–©': u'Sch', u'–Æ': u'Yu', u'–Ø': u'Ya',
    }

    lower_case_letters = {
        u'–∞': u'a', u'–±': u'b', u'–≤': u'v', u'–≥': u'g', u'–¥': u'd', u'–µ': u'e', u'—ë': u'e', u'–∂': u'zh',
        u'–∑': u'z', u'–∏': u'i', u'–π': u'y', u'–∫': u'k', u'–ª': u'l', u'–º': u'm', u'–Ω': u'n', u'–æ': u'o',
        u'–ø': u'p', u'—Ä': u'r', u'—Å': u's', u'—Ç': u't', u'—É': u'u', u'—Ñ': u'f', u'—Ö': u'h', u'—Ü': u'ts',
        u'—á': u'ch', u'—à': u'sh', u'—â': u'sch', u'—ä': u'', u'—ã': u'y', u'—å': u'', u'—ç': u'e', u'—é': u'yu',
        u'—è': u'ya',
    }

    capital_and_lower_case_letter_pairs = {}

    for capital_letter, capital_letter_translit in capital_letters_transliterated_to_multiple_letters.items():
        for lowercase_letter, lowercase_letter_translit in lower_case_letters.items():
            capital_and_lower_case_letter_pairs[u"%s%s" % (capital_letter, lowercase_letter)] = u"%s%s" % (
                capital_letter_translit, lowercase_letter_translit)

    for dictionary in (capital_and_lower_case_letter_pairs, capital_letters, lower_case_letters):
        for cyrillic_string, latin_string in dictionary.items():
            string = re.sub(cyrillic_string, latin_string, string)

    for cyrillic_string, latin_string in capital_letters_transliterated_to_multiple_letters.items():
        string = re.sub(cyrillic_string, latin_string.upper(), string)

    return string.upper()


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
def format_phone(phone: str) -> str:
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    phone = re.sub(r'\D', '', phone)

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
    if phone.startswith('8'):
        phone = '7' + phone[1:]

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8, –¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ
    elif not phone.startswith('7'):
        phone = '7' + phone
    return f"+{phone}"


def validate_phone(phone):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX.
    """
    pattern = re.compile(r'^\+7\d{10}$')
    return pattern.match(phone)


def generate_address_instructions(name_cyrillic, personal_code, name_translit, pickup_point_code):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –∞–¥—Ä–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏.
    """
    instructions = {
        "pv_astana_1": (
            f"üôèüèª –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {name_cyrillic}, –º—ã —Ä–∞–¥—ã, —á—Ç–æ –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–∞—Å\\!\n\n"
            f"üìå –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥:\n"
            f"‰Ω≥‰∫∫AST{personal_code}\n\n"
            f"üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –∞–¥—Ä–µ—Å–∞ —Å–∫–ª–∞–¥–∞ –≤ –ö–∏—Ç–∞–µ:\n"
            f"1\\) `‰Ω≥‰∫∫AST{personal_code}`\n"
            f"2\\) `18346727700`\n"
            f"3\\) `Âπø‰∏úÁúÅ ‰ΩõÂ±±Â∏Ç ÂçóÊµ∑Âå∫`\n"
            f"4\\) `‰∏πÁÅ∂ÈïáÈáëÊ≤ôÈì∂Ê≤ôÂçóË∑Ø88Âè∑ (‰Ω≥‰∫∫AST{personal_code}_{name_translit}_ASTANA+ESIL)`\n\n"
            f"–í —Ç—Ä–µ—Ç—å–µ–º –ø—É–Ω–∫—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é\\. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å\\.\n\n"
            f"üìç –ê–¥—Ä–µ—Å —Ñ–∏–ª–∏–∞–ª–∞:\n"
            f"—É–ª\\. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞, 42\n\n"
            f"–°—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø—É: https://t\\.me/iCargoLife\n"
            f"üìû –í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –ø–æ –Ω–æ–º–µ—Ä—É: 8 \\(700\\) 060\\-10\\-36\n\n"
            f"–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞\\. –ú—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏ –∏ –±—É–¥–µ–º —Ä–∞–¥—ã –ø–æ–º–æ—á—å –í–∞–º –ø–æ –ª—é–±–æ–º—É –≤–æ–ø—Ä–æ—Å—É"
        ),
        "pv_astana_2": (
            f"üôèüèª –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {name_cyrillic}, –º—ã —Ä–∞–¥—ã, —á—Ç–æ –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–∞—Å\\!\n\n"
            f"üìå –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥:\n"
            f"È¢ÜË¢ñAST{personal_code}\n\n"
            f"üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –∞–¥—Ä–µ—Å–∞ —Å–∫–ª–∞–¥–∞ –≤ –ö–∏—Ç–∞–µ:\n"
            f"1\\) `È¢ÜË¢ñAST{personal_code}`\n"
            f"2\\) `18346727700`\n"
            f"3\\) `Âπø‰∏úÁúÅ ‰ΩõÂ±±Â∏Ç ÂçóÊµ∑Âå∫`\n"
            f"4\\) `‰∏πÁÅ∂ÈïáÈáëÊ≤ôÈì∂Ê≤ôÂçóË∑Ø88Âè∑ (È¢ÜË¢ñAST{personal_code}_{name_translit}_ASTANA+ALMATINSKIY)`\n\n"
            f"–í —Ç—Ä–µ—Ç—å–µ–º –ø—É–Ω–∫—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é\\. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å\\.\n\n"
            f"üìç –ê–¥—Ä–µ—Å —Ñ–∏–ª–∏–∞–ª–∞:\n"
            f"—É–ª\\. –ö–∞–∂—ã–º—É–∫–∞–Ω, 12–ë\n\n"
            f"–°—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø—É: https://t\\.me/iCargoLife\n"
            f"üìû –í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –ø–æ –Ω–æ–º–µ—Ä—É: 8 \\(708\\) 498\\-50\\-58\n\n"
            f"–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞\\. –ú—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏ –∏ –±—É–¥–µ–º —Ä–∞–¥—ã –ø–æ–º–æ—á—å –í–∞–º –ø–æ –ª—é–±–æ–º—É –≤–æ–ø—Ä–æ—Å—É"
        ),
        "pv_karaganda_1": (
            f"üôèüèª –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {name_cyrillic}, –º—ã —Ä–∞–¥—ã, —á—Ç–æ –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–∞—Å\\!\n\n"
            f"üìå –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥:\n"
            f"ÊâçÂ≠êKRG{personal_code}\n\n"
            f"üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –∞–¥—Ä–µ—Å–∞ —Å–∫–ª–∞–¥–∞ –≤ –ö–∏—Ç–∞–µ:\n"
            f"1\\) `ÊâçÂ≠êKRG{personal_code}`\n"
            f"2\\) `18346727700`\n"
            f"3\\) `Âπø‰∏úÁúÅ ‰ΩõÂ±±Â∏Ç ÂçóÊµ∑Âå∫`\n"
            f"4\\) `‰∏πÁÅ∂ÈïáÈáëÊ≤ôÈì∂Ê≤ôÂçóË∑Ø88Âè∑ (ÊâçÂ≠êKRG{personal_code}_{name_translit}_KRG+UG)`\n\n"
            f"–í —Ç—Ä–µ—Ç—å–µ–º –ø—É–Ω–∫—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é\\. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å\\.\n\n"
            f"üìç –ê–¥—Ä–µ—Å —Ñ–∏–ª–∏–∞–ª–∞:\n"
            f"—É–ª\\. –Ø–∑–µ–≤–∞ 14/1, –¢–†–¶ –ü—Ä–æ—Å–ø–µ–∫—Ç \\(–ö–æ—Ä–∑–∏–Ω–∞\\), 3 —ç—Ç–∞–∂, 24 –±—É—Ç–∏–∫\n\n"
            f"–°—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø—É: https://t\\.me/iCargoLife\n"
            f"üìû –í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –ø–æ –Ω–æ–º–µ—Ä—É: 8 \\(776\\) 060\\-10\\-36\n\n"
            f"–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞\\. –ú—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏ –∏ –±—É–¥–µ–º —Ä–∞–¥—ã –ø–æ–º–æ—á—å –í–∞–º –ø–æ –ª—é–±–æ–º—É –≤–æ–ø—Ä–æ—Å—É"
        )
    }
    return instructions.get(pickup_point_code, "–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.")


def export_database_to_excel():
    conn = sqlite3.connect(DATABASE_PATH)

    table_name = "clients"
    query = f"SELECT * FROM {table_name}"
    df = pd.read_sql_query(query, conn)

    output_file = "/data/output.xlsx"
    df.to_excel(output_file, index=False, engine='openpyxl')

    conn.close()
    return output_file


def trim_time_from_iso(iso_str):
    return datetime.fromisoformat(iso_str).date().isoformat() if iso_str else None


def format_date(iso_str: str) -> str:
    try:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy
        return datetime.fromisoformat(iso_str).strftime("%d.%m.%Y")
    except Exception:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∞—Ç–∞"
